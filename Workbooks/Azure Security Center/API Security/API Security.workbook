{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "## API Security Dashboard \r\n\r\nThis workbook has been created to provide a security mapping for Microsoft Defender for APIs plan based on the resource telemetry in your own environment. Please note that these views are based on your API infrastructure."
      },
      "name": "Intro"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "7767523e-f230-4562-b00c-bce5a7d38fe7",
            "version": "KqlParameterItem/1.0",
            "name": "subscription",
            "label": "Subscription",
            "type": 6,
            "description": "Please select one or several Subscription in your environment",
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "includeAll": true,
              "showDefault": false
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "f38b2b18-3eda-4aeb-8155-b0e9b267864a",
            "version": "KqlParameterItem/1.0",
            "name": "severity",
            "label": "Alert Severity",
            "type": 2,
            "description": "Please select an alert severity.",
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ],
              "selectAllValue": "",
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\": \"High\", \"label\":\"High\"},\r\n    {\"value\": \"Medium\", \"label\":\"Medium\"},\r\n    {\"value\": \"Low\", \"label\":\"Low\"},\r\n    {\"value\": \"Informational\", \"label\":\"Informational\"}\r\n]\r\n    ",
            "timeContext": {
              "durationMs": 86400000
            },
            "defaultValue": "value::all",
            "value": [
              "value::all"
            ]
          }
        ],
        "style": "above",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "select_subscriptions"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "tabs",
        "links": [
          {
            "id": "7b8f3245-20ab-43a8-8b15-7b60d449308e",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "ðŸ”Ž Overview",
            "subTarget": "overview",
            "preText": "Overview",
            "style": "link"
          },
          {
            "id": "73f4146e-9c22-4f96-885a-34158a5617a3",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "ðŸ”µ Hardening Recommendations",
            "subTarget": "recommendations",
            "style": "link"
          },
          {
            "id": "c973a4aa-7315-4f9c-8b36-44ea4f6374dc",
            "cellValue": "tab",
            "linkTarget": "parameter",
            "linkLabel": "ðŸ”” Threat Detection - Alerts",
            "subTarget": "alerts",
            "style": "link"
          }
        ]
      },
      "name": "Tab_Menu"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details.[\"IsIncident\"]\r\n| extend AlertDisplayName = Details.[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details.[\"SystemAlertId\"]\r\n| extend Severity = Details.[\"Severity\"]\r\n| extend AlertUri = Details.[\"AlertUri\"]\r\n| extend Status = Details.[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details.[\"Intent\"]\r\n| parse AlertUri with * '/subscriptionId/'  SubscriptionId  '/' *\r\n| parse AlertUri with * '/resourceGroup/'  ResourceGroup  '/' *\r\n| parse AlertUri with * '/location/'  Location  \r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n| extend ResourceIdentifiers = Details.[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = properties.TimeGeneratedUtc\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where AlertDisplayName !startswith ('[SAMPLE ALERT]')\r\n| where Severity in~ ({severity})\r\n| summarize count() by tostring(Severity)",
        "size": 3,
        "title": "Alert Summary",
        "noDataMessage": "No alerts found",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Severity",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "colors",
                "thresholdsGrid": [
                  {
                    "operator": "contains",
                    "thresholdValue": "High",
                    "representation": "redBright",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "Medium",
                    "representation": "orange",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "Low",
                    "representation": "yellow",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "contains",
                    "thresholdValue": "Informational",
                    "representation": "gray",
                    "text": "{0}{1}"
                  },
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "text": "{0}{1}"
                  }
                ]
              }
            },
            {
              "columnMatch": "SystemAlertId",
              "formatter": 5
            },
            {
              "columnMatch": "IsIncident",
              "formatter": 1
            },
            {
              "columnMatch": "AlertURI",
              "formatter": 5
            },
            {
              "columnMatch": "SubscriptionId",
              "formatter": 15,
              "formatOptions": {
                "linkTarget": "Resource",
                "showIcon": true
              }
            },
            {
              "columnMatch": "Location",
              "formatter": 5
            },
            {
              "columnMatch": "ResourceId",
              "formatter": 5
            }
          ],
          "sortBy": [
            {
              "itemKey": "Tactics",
              "sortOrder": 2
            }
          ],
          "labelSettings": [
            {
              "columnId": "AlertDisplayName",
              "label": "Alert Name"
            },
            {
              "columnId": "IsIncident",
              "label": "Incident/alert"
            },
            {
              "columnId": "ResourceGroup",
              "label": "Resource Group"
            },
            {
              "columnId": "Resource",
              "label": "Kubernetes Cluster"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "Tactics",
            "sortOrder": 2
          }
        ],
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Severity",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "none"
            }
          },
          "showBorder": false
        },
        "mapSettings": {
          "locInfo": "LatLong",
          "sizeSettings": "count_",
          "sizeAggregation": "Sum",
          "legendMetric": "count_",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "type": "heatmap",
            "colorAggregation": "Sum",
            "nodeColorField": "count_",
            "heatmapPalette": "greenRed"
          }
        },
        "textSettings": {
          "style": "bignumber"
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "customWidth": "50",
      "name": "Overview_Alerts"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n    | where type =~ \"microsoft.security/locations/alerts\"\r\n    | extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n    | extend IsIncident = properties.[\"IsIncident\"]\r\n    | extend AlertDisplayName = properties.[\"AlertDisplayName\"]\r\n    | extend SystemAlertId = properties.[\"SystemAlertId\"]\r\n    | extend Severity = properties.[\"Severity\"]\r\n    | extend Status = properties.[\"Status\"]\r\n    | extend Tactics = split(properties.[\"Intent\"],\",\")\r\n    | mv-expand Tactics\r\n    | extend Tactic = trim(\" \",tostring(Tactics))\r\n    | extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n    | extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n    | extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n    | extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n    | extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n    | extend ResourceIdentifiers = properties.[\"ResourceIdentifiers\"]\r\n    | mv-expand ResourceIdentifiers\r\n    | extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n    | extend Resource = tolower(tostring(ResourceId))\r\n    | project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n    | extend ResourceIdentifiers = properties.[\"ResourceIdentifiers\"]\r\n    | mv-expand ResourceIdentifiers\r\n    | extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n    | extend Resource = tolower(tostring(ResourceId))\r\n    | where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n    | extend affectedResourceId = tolower(affectedResourceId)\r\n    | extend ResourceGroup = tolower(resourceGroup)\r\n    | where Status == \"Active\"\r\n    | extend ResourceGroup = iif(isempty(ResourceGroup), \" \", ResourceGroup)\r\n    | where AlertDisplayName !startswith ('[SAMPLE ALERT]')\r\n    | where Severity in~ ({severity})\r\n    | distinct ['id'], Tactic\r\n    | summarize count() by Tactic\r\n ",
        "size": 3,
        "title": "Alerts by MITRE ATT&CK  Tactics",
        "noDataMessage": "No alerts found",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "tileSettings": {
          "titleContent": {
            "columnMatch": "Tactic",
            "formatter": 1
          },
          "leftContent": {
            "columnMatch": "count_",
            "formatter": 12,
            "formatOptions": {
              "palette": "auto",
              "compositeBarSettings": {
                "labelText": "",
                "columnSettings": []
              }
            }
          },
          "showBorder": false
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "customWidth": "50",
      "name": "Overview_Alert_Mitre"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n    | where type == \"microsoft.security/assessments\"\r\n    | where id contains \"microsoft.apimanagement/service\" or id contains \"Microsoft.ApiSecurity\"\r\n    | extend status = properties.status.code, severity = tostring(properties.metadata.severity)\r\n    | where status == 'Unhealthy'\r\n    | extend displayName = tostring(properties.displayName)\r\n    | summarize count() by severity",
        "size": 3,
        "title": "API Security Findings by Severity",
        "noDataMessage": "No unhealthy APIs found",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "ResourceGroup",
              "formatter": 5
            },
            {
              "columnMatch": "Resource",
              "formatter": 5,
              "formatOptions": {
                "customColumnWidthSetting": "20ch"
              }
            },
            {
              "columnMatch": "Total",
              "formatter": 1,
              "formatOptions": {
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "sevH",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "Sev0",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "sevM",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "Sev1",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "sevL",
              "formatter": 18,
              "formatOptions": {
                "thresholdsOptions": "icons",
                "thresholdsGrid": [
                  {
                    "operator": "Default",
                    "thresholdValue": null,
                    "representation": "Sev3",
                    "text": "{0}{1}"
                  }
                ],
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "patchAvailable",
              "formatter": 1,
              "formatOptions": {
                "compositeBarSettings": {
                  "labelText": "",
                  "columnSettings": []
                },
                "customColumnWidthSetting": "15ch"
              }
            },
            {
              "columnMatch": "CVEcount",
              "formatter": 5,
              "formatOptions": {
                "customColumnWidthSetting": "15ch"
              }
            }
          ],
          "rowLimit": 1000
        },
        "sortBy": [],
        "tileSettings": {
          "showBorder": false
        },
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "Medium",
              "color": "orange"
            },
            {
              "seriesName": "High",
              "color": "redBright"
            },
            {
              "seriesName": "Low",
              "color": "blue"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "customWidth": "50",
      "name": "Overview_API_Findings_Severity"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n    | where type == \"microsoft.security/assessments\"\r\n    | where name == \"1c0ba94f-e732-43c7-bf3a-05e80f45d642\"\r\n    | extend status = properties.status.code\r\n    | summarize count() by tostring(status)",
        "size": 3,
        "title": "Defender for APIs Coverage",
        "noDataMessage": "All API Management Services onboarded",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "Unhealthy",
              "label": "Unhealthy Endpoints"
            },
            {
              "seriesName": "Healthy",
              "label": "Healthy Endpoints"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "customWidth": "50",
      "name": "Overview_APIs_Coverage"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type == \"microsoft.security/pricings\"\r\n| where name == \"Api\"\r\n| extend Tier = properties.pricingTier\r\n| project subscriptionId, Tier \r\n",
        "size": 0,
        "title": "Subscription Coverage for Defender for APIs",
        "noDataMessage": "No subscription data.",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "$gen_link_Tier_1",
              "sortOrder": 1
            }
          ],
          "labelSettings": [
            {
              "columnId": "subscriptionId",
              "label": "Subscription"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_link_Tier_1",
            "sortOrder": 1
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "overview"
      },
      "name": "Defender for APIs Plan Coverage"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/assessments\" and properties.status.code =~ \"Unhealthy\"\r\n| where id contains \"microsoft.apimanagement/service\" or id contains \"Microsoft.ApiSecurity\"\r\n| extend severityFilter = tostring(\"{severity}\"), severity = tostring(properties.metadata.severity)\r\n| project severity, severityFilter, id\r\n| where severityFilter has severity\r\n| summarize recommendations = dcount(id) by severity",
        "size": 3,
        "title": "Unhealthy Recommendations by Severity",
        "noDataMessage": "No unhealthy recommendations found.",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "Unhealthy recommendations"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/assessments\"\r\n| where id contains \"microsoft.apimanagement/service\" or id contains \"Microsoft.ApiSecurity\"\r\n| extend severityFilter = tostring(\"{severity}\"), severity = tostring(properties.metadata.severity)\r\n| project severity, severityFilter, id, statusCode = properties.status.code\r\n| where severityFilter has severity\r\n| summarize recommendations = dcount(id) by tostring(statusCode)",
        "size": 3,
        "title": "Total Recommendations by Status",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "Total Recommendations by Status"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n    | where type == \"microsoft.security/assessments\"\r\n    | where id contains \"microsoft.apimanagement/service\" or id contains \"Microsoft.ApiSecurity\"\r\n    | extend status = properties.status.code, Severity = properties.metadata.severity\r\n    | where status == 'Unhealthy'\r\n    | extend displayName = tostring(properties.displayName)\r\n    | summarize count() by displayName, tostring(Severity)\r\n    | order by tostring(Severity) desc",
        "size": 3,
        "title": "Unhealthy Resource Count by Recommendation",
        "exportedParameters": [
          {
            "fieldName": "displayName",
            "parameterName": "selectedAPIM",
            "parameterType": 1,
            "defaultValue": "All"
          },
          {
            "fieldName": "apimSelected",
            "parameterName": "apimSelected",
            "parameterType": 1,
            "defaultValue": "false"
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "Severity",
              "sortOrder": 2
            }
          ],
          "labelSettings": [
            {
              "columnId": "displayName",
              "label": "Recommendation Name"
            },
            {
              "columnId": "count_",
              "label": "Resource Count"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "Severity",
            "sortOrder": 2
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "name": "Unhealthy Resource Count by Recommendation"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n    | where type == \"microsoft.security/assessments\"\r\n    | where id contains \"microsoft.apimanagement/service\" or id contains \"Microsoft.ApiSecurity\"\r\n    | extend status = properties.status.code, severity = properties.metadata.severity\r\n    | where status == 'Unhealthy'\r\n    | extend displayName = tostring(properties.displayName)\r\n    | where displayName == '{selectedAPIM}'\r\n    | extend resourceId = tostring(properties.resourceDetails.Id)\r\n    | project displayName, resourceId, status, severity",
        "size": 3,
        "title": "Unhealthy Resources",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "gridSettings": {
          "labelSettings": [
            {
              "columnId": "displayName",
              "label": "Recommendation Name"
            },
            {
              "columnId": "resourceId",
              "label": "Affected Resource"
            },
            {
              "columnId": "status",
              "label": "Status"
            },
            {
              "columnId": "severity",
              "label": "Severity"
            }
          ]
        }
      },
      "conditionalVisibilities": [
        {
          "parameterName": "apimSelected",
          "comparison": "isNotEqualTo",
          "value": "false"
        },
        {
          "parameterName": "tab",
          "comparison": "isEqualTo",
          "value": "recommendations"
        }
      ],
      "name": "Affected APIs"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate, NumberOfExternalApiEndpoints=properties.NumberOfExternalEndpoints\r\n| where properties.PII != \"{}\" and properties.PII != \"\"\r\n| where IsEndpointExternal = true\r\n| where IsEndpointAuthorized != \"\"\r\n| summarize count() by tostring(IsEndpointAuthorized)",
        "size": 3,
        "title": "Authorization Status on External Endpoints with Sensitive Data",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "false",
              "label": "Unauthorized",
              "color": "redBright"
            },
            {
              "seriesName": "true",
              "label": "Authorized",
              "color": "blue"
            },
            {
              "seriesName": "",
              "label": "Unknown",
              "color": "green"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "Authorization Status on External Endpoints with Sensitive Data"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate, IsEndpointExternal = properties.IsExternal\r\n| where IsEndpointActive = true\r\n| where IsEndpointAuthorized != \"\"\r\n| where IsEndpointExternal = true\r\n| summarize count() by tostring(IsEndpointAuthorized)",
        "size": 3,
        "title": "Authorization Status on Active and External Endpoints",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "chartSettings": {
          "seriesLabelSettings": [
            {
              "seriesName": "false",
              "label": "Unauthorized",
              "color": "redBright"
            },
            {
              "seriesName": "true",
              "label": "Authorized",
              "color": "blue"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "Authorization Status on Active and External Endpoints"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| where properties.PII != \"{}\" and properties.PII != \"\"\r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized,NumberOfExternalApiEndpoints=properties.NumberOfExternalEndpoints, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate, IsEndpointExternal = properties.IsExternal\r\n| where IsEndpointAuthorized == \"false\"\r\n| where IsEndpointExternal = true\r\n| project CollectionName, DisplayName, Endpoint, IsEndpointActive, IsEndpointAuthorized, IsEndpointExternal, id ",
        "size": 3,
        "title": "List of Unauthorized External Endpoints with Sensitive Data",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "List of Unauthorized External Endpoints with Sensitive Data"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate, IsEndpointExternal = properties.IsExternal\r\n| where IsEndpointAuthorized == \"false\"\r\n| where IsEndpointActive == \"true\"\r\n| where IsEndpointExternal = true\r\n| project CollectionName, DisplayName, Endpoint, HttpMethod, IsEndpointExternal, IsEndpointActive, IsEndpointAuthorized, id \r\n",
        "size": 3,
        "title": "List of Active and Unauthorized External Endpoints",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "sortBy": []
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "customWidth": "50",
      "name": "List of Active and Unauthorized External Endpoints"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| where properties.PII != \"{}\" and properties.PII != \"\"\r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate \r\n| where IsEndpointAuthorized == \"false\"\r\n| extend PII = parse_json(PII)\r\n| mv-expand PII\r\n| extend SensitiveData = tostring(PII)\r\n| extend SensitiveData = replace('{', '', SensitiveData)\r\n| extend SensitiveData = replace('}', '', SensitiveData)\r\n| extend SensitiveData = replace('\"', '', SensitiveData)\r\n| extend SensitiveData = replace(':85', '', SensitiveData)\r\n| extend SensitiveData = replace(':98', '', SensitiveData)\r\n| summarize count() by SensitiveData",
        "size": 0,
        "title": "Count of Discovered Classifications",
        "noDataMessage": "No sensitive data classifications discovered.",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "barchart"
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "name": "Count of Discovered Classifications"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections\", \"microsoft.apisecurity/apicollections\")\r\n| project CollectionName = properties.DisplayName, APIM=properties.DiscoveredViaDisplayName, SuspectedPIICount=properties.SuspectedPII,  ExternalApiEndpoints=properties.NumberOfExternalEndpoints, TotalApiEndpoints=properties.NumberOfTotalApiEndpoints, Id=properties.id\r\n| where SuspectedPIICount != \"0\" | order by toint(SuspectedPIICount) desc\r\n",
        "size": 3,
        "title": " API Collections with Suspected PII",
        "noDataMessage": "No Sensitive Data Discovered",
        "exportedParameters": [
          {
            "fieldName": "Id",
            "parameterName": "CollectionName",
            "parameterType": 1
          },
          {
            "fieldName": "IdSelected",
            "parameterName": "IdSelected",
            "parameterType": 1,
            "defaultValue": "false"
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "sortBy": []
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "recommendations"
      },
      "name": "API Collections with Suspected PII"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources \r\n| union extensibilityresources \r\n| where type in (\"microsoft.security/apicollections/apiendpoints\", \"microsoft.apisecurity/apicollections/apicollectiondetails\") \r\n| where properties.PII != \"{}\" and properties.PII != \"\"\r\n| extend  DisplayName = properties.DisplayName, CollectionName = properties.CollectionName, CollectionId = properties.CasApiCollectionId, Endpoint=properties.EndPoint, IsEndpointActive=properties.IsEndpointActive, IsEndpointAuthorized=properties.IsEndpointAuthorized, IsEndpointExternal = properties.IsExternal, PII=properties.PII, HttpMethod=properties.HttpMethod, DiscoveryDate=properties.DiscoveryDate, TriggerDate=properties.TriggerDate\r\n| where CollectionId == '{CollectionName}'\r\n| extend PII = parse_json(PII)\r\n| mv-expand PII\r\n| extend SensitiveData = tostring(PII)\r\n| extend SensitiveData = replace('{', '', SensitiveData)\r\n| extend SensitiveData = replace('}', '', SensitiveData)\r\n| extend SensitiveData = replace('\"', '', SensitiveData)\r\n| extend SensitiveData = replace(':85', '', SensitiveData)\r\n| extend SensitiveData = replace(':98', '', SensitiveData)\r\n| project CollectionName, DisplayName, Endpoint, SensitiveData, HttpMethod, IsEndpointExternal, IsEndpointActive, IsEndpointAuthorized, DiscoveryDate, TriggerDate",
        "size": 3,
        "title": "Endpoints with Sensitive Data",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "$gen_link_DisplayName_1",
              "sortOrder": 1
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_link_DisplayName_1",
            "sortOrder": 1
          }
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "tab",
          "comparison": "isEqualTo",
          "value": "recommendations"
        },
        {
          "parameterName": "IdSelected",
          "comparison": "isNotEqualTo",
          "value": "false"
        }
      ],
      "name": "Endpoints with Sensitive Data"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details.[\"IsIncident\"]\r\n| extend AlertDisplayName = Details.[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details.[\"SystemAlertId\"]\r\n| extend Severity = Details.[\"Severity\"]\r\n| extend AlertUri = Details.[\"AlertUri\"]\r\n| extend Status = Details.[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details.[\"Intent\"]\r\n| parse AlertUri with * '/subscriptionId/'  SubscriptionId  '/' *\r\n| parse AlertUri with * '/resourceGroup/'  ResourceGroup  '/' *\r\n| parse AlertUri with * '/location/'  Location  \r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n| extend ResourceIdentifiers = Details.[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = properties.TimeGeneratedUtc\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where Severity in~ ({severity})\r\n| summarize count() by tostring(AlertDisplayName)\r\n| top 10 by count_",
        "size": 3,
        "title": "Top 10 Alert Types",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "piechart",
        "gridSettings": {
          "labelSettings": [
            {
              "columnId": "AlertDisplayName",
              "label": "Alert Name"
            },
            {
              "columnId": "count_",
              "label": "Alert Count"
            }
          ]
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "alerts"
      },
      "customWidth": "50",
      "name": "Top 10 Alert Types"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details.[\"IsIncident\"]\r\n| extend AlertDisplayName = Details.[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details.[\"SystemAlertId\"]\r\n| extend Severity = Details.[\"Severity\"]\r\n| extend AlertUri = Details.[\"AlertUri\"]\r\n| extend Status = Details.[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details.[\"Intent\"]\r\n| parse AlertUri with * '/subscriptionId/'  SubscriptionId  '/' *\r\n| parse AlertUri with * '/resourceGroup/'  ResourceGroup  '/' *\r\n| parse AlertUri with * '/location/'  Location  \r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n| extend ResourceIdentifiers = Details.[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = properties.TimeGeneratedUtc\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where Severity in~ ({severity})\r\n| summarize count() by Resource \r\n| sort by count_ desc\r\n| top 10 by count_",
        "size": 3,
        "title": "Affected Resources",
        "exportedParameters": [
          {
            "fieldName": "Resource",
            "parameterName": "selectedAlert",
            "parameterType": 1
          },
          {
            "fieldName": "alertSelected",
            "parameterName": "alertSelected",
            "parameterType": 1,
            "defaultValue": "false"
          }
        ],
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "gridSettings": {
          "sortBy": [
            {
              "itemKey": "$gen_link_Resource_0",
              "sortOrder": 1
            }
          ],
          "labelSettings": [
            {
              "columnId": "Resource",
              "label": "Resource"
            },
            {
              "columnId": "count_",
              "label": "Alert Count"
            }
          ]
        },
        "sortBy": [
          {
            "itemKey": "$gen_link_Resource_0",
            "sortOrder": 1
          }
        ]
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "alerts"
      },
      "customWidth": "50",
      "name": "Resources with Alerts"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details.[\"IsIncident\"]\r\n| extend AlertDisplayName = Details.[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details.[\"SystemAlertId\"]\r\n| extend Severity = Details.[\"Severity\"]\r\n| extend AlertUri = Details.[\"AlertUri\"]\r\n| extend Status = Details.[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details.[\"Intent\"]\r\n| parse AlertUri with * '/subscriptionId/'  SubscriptionId  '/' *\r\n| parse AlertUri with * '/resourceGroup/'  ResourceGroup  '/' *\r\n| parse AlertUri with * '/location/'  Location  \r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n| extend ResourceIdentifiers = Details.[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = properties.TimeGeneratedUtc\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where Severity in~ ({severity})\r\n| where Resource == '{selectedAlert}'\r\n| project\r\n    Resource,\r\n    alertId = id,\r\n    AlertDisplayName,\r\n    tostring(Severity),\r\n    AlertTime,\r\n    Status,\r\n    Tactics",
        "size": 3,
        "title": "Active Alerts on Selected Resource",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ]
      },
      "conditionalVisibilities": [
        {
          "parameterName": "tab",
          "comparison": "isEqualTo",
          "value": "alerts"
        },
        {
          "parameterName": "alertSelected",
          "comparison": "isNotEqualTo",
          "value": "false"
        }
      ],
      "name": "Alerts"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details[\"IsIncident\"]\r\n| extend AlertDisplayName = Details[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details[\"SystemAlertId\"]\r\n| extend Severity = Details[\"Severity\"]\r\n| extend AlertUri = Details[\"AlertUri\"]\r\n| extend Status = Details[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details[\"Intent\"]\r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| extend ResourceIdentifiers = Details[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers)[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = todatetime(properties.TimeGeneratedUtc)\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where Severity in~ ({severity})\r\n| summarize count() by bin(AlertTime, 1d)\r\n",
        "size": 3,
        "title": "Alert Time Chart",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "barchart",
        "chartSettings": {
          "xAxis": "AlertTime",
          "showLegend": true,
          "xSettings": {
            "numberFormatSettings": {
              "unit": 27,
              "options": {
                "style": "decimal",
                "useGrouping": true
              }
            }
          }
        },
        "mapSettings": {
          "locInfo": "LatLong",
          "sizeSettings": "count_",
          "sizeAggregation": "Sum",
          "legendMetric": "count_",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "type": "heatmap",
            "colorAggregation": "Sum",
            "nodeColorField": "count_",
            "heatmapPalette": "greenRed"
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "alerts"
      },
      "customWidth": "50",
      "name": "Alert Time Chart"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "securityresources\r\n| where type =~ \"microsoft.security/locations/alerts\"\r\n| extend isAzure = tostring(properties.ResourceIdentifiers) matches regex '\"Type\"\\\\s*:\\\\s*\"AzureResource\"'\r\n| extend Details = parse_json(properties)\r\n| extend IsIncident = Details.[\"IsIncident\"]\r\n| extend AlertDisplayName = Details.[\"AlertDisplayName\"]\r\n| extend SystemAlertId = Details.[\"SystemAlertId\"]\r\n| extend Severity = Details.[\"Severity\"]\r\n| extend AlertUri = Details.[\"AlertUri\"]\r\n| extend Status = Details.[\"Status\"]\r\n| where Status == \"Active\"\r\n| extend Tactics = Details.[\"Intent\"]\r\n| parse AlertUri with * '/subscriptionId/'  SubscriptionId  '/' *\r\n| parse AlertUri with * '/resourceGroup/'  ResourceGroup  '/' *\r\n| parse AlertUri with * '/location/'  Location  \r\n| extend affectedResourceId = extract('\"AzureResourceId\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.ResourceIdentifiers))\r\n| extend hostName = iff(isAzure, \"\", extract('\"HostName\"\\\\s*:\\\\s*\"([^\"]*)\"', 1, tostring(properties.Entities)))\r\n| extend splitAffectedResourceId = split(affectedResourceId, \"/\")\r\n| extend resourceNameIndex = iff(array_length(splitAffectedResourceId) > 1, array_length(splitAffectedResourceId) - 1, 0)\r\n| extend affectedResourceName = iff(isAzure, splitAffectedResourceId[resourceNameIndex], iff(isempty(hostName), \"Non-Azure\", hostName))\r\n| project-away resourceNameIndex, splitAffectedResourceId, hostName\r\n| extend ResourceIdentifiers = Details.[\"ResourceIdentifiers\"]\r\n| mv-expand ResourceIdentifiers\r\n| extend ResourceId = parse_json(ResourceIdentifiers).[\"AzureResourceId\"]\r\n| extend Resource = tolower(tostring(ResourceId))\r\n| extend AlertTime = properties.TimeGeneratedUtc\r\n| where Resource has \"microsoft.APISecurity\" or Resource has \"microsoft.apimanagement\"\r\n| where Severity in~ ({severity})\r\n| summarize count() by tostring(location)\r\n",
        "size": 3,
        "title": "Map of Affected Resources by Location",
        "queryType": 1,
        "resourceType": "microsoft.resourcegraph/resources",
        "crossComponentResources": [
          "{subscription}"
        ],
        "visualization": "map",
        "mapSettings": {
          "locInfo": "AzureLoc",
          "locInfoColumn": "location",
          "sizeSettings": "count_",
          "sizeAggregation": "Sum",
          "labelSettings": "location",
          "legendMetric": "count_",
          "legendAggregation": "Sum",
          "itemColorSettings": {
            "nodeColorField": "count_",
            "colorAggregation": "Sum",
            "type": "heatmap",
            "heatmapPalette": "greenRed"
          }
        }
      },
      "conditionalVisibility": {
        "parameterName": "tab",
        "comparison": "isEqualTo",
        "value": "alerts"
      },
      "customWidth": "50",
      "name": "Map of Affected Resources by Location"
    }
  ],
  "fallbackResourceIds": [
    "Azure Security Center"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}
